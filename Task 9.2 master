#include <Wire.h>
#define SLAVE_ADDR 0x10 // Slave I2C address

// Configures I2C speed using TWI prescaler and TWBR, based on frequency
void configureI2CSpeed(uint32_t freq)
{
    // 25 kHz (slow mode)
    if (freq == 25000)
    {
        // 25 kHz requires prescaler = 4, TWBR = 78
        TWSR = (TWSR & ~((1 << TWPS1) | (1 << TWPS0))) | (1 << TWPS0);
        TWBR = 78;

        Wire.begin(); // Initialize I2C in master mode
        TWSR = (TWSR & ~((1 << TWPS1) | (1 << TWPS0))) | (1 << TWPS0);
        TWBR = 78;

        Serial.println("Configured 25 kHz, Prescaler=4, TWBR=78");
        return;  
    }

    // Calculate TWBR for the given frequency
    uint32_t twbr_val = (F_CPU / freq - 16) / 2;

    // Ensure TWBR is within 8 bits
    if (twbr_val > 255)
        twbr_val = 255;

    TWSR &= ~((1 << TWPS1) | (1 << TWPS0)); // Set prescaler to 1
    TWBR = (uint8_t)twbr_val; // Set TWBR value

    Wire.begin(); // Reinitialize I2C
    TWSR &= ~((1 << TWPS1) | (1 << TWPS0));
    TWBR = (uint8_t)twbr_val;

    Serial.print("Configured freq = ");
    Serial.print(freq);
    Serial.print(" Hz, TWBR = ");
    Serial.println((uint8_t)twbr_val);
}

// Performs one I2C exchange: master sends 1 byte, slave responds with 1 byte
void exchange_once()
{
    Wire.beginTransmission(SLAVE_ADDR); // Start transmission to slave
    Wire.write(0x55); // Send test byte
    Wire.endTransmission(); // End transmission

    Wire.requestFrom(SLAVE_ADDR, 1); // Request 1 byte from slave
    while (Wire.available() == 0); // Wait for data
    uint8_t response = Wire.read(); // Read byte from slave
}

// Measures time for 50 exchanges in microseconds
uint32_t run_test()
{
    uint32_t t0 = micros(); // Start time
    for (int i = 0; i < 50; i++) // 50 exchanges
        exchange_once();
    uint32_t t1 = micros(); // End time

    return (t1 - t0);  // Return total time
}

void setup()
{
    Serial.begin(9600); // Start serial monitor
    delay(500); 

    // Test 1: Default 100 kHz
    Wire.begin(); // Initialize I2C
    uint32_t t_default = run_test(); // Measure time for 50 exchanges
    Serial.print("Default (~100 kHz) time (us): ");
    Serial.println(t_default);

    delay(1000);

    // Test 2: 25 kHz (slow mode, prescaler = 4, TWBR = 78)
    configureI2CSpeed(25000);
    uint32_t t25 = run_test();
    Serial.print("25 kHz time (us): ");
    Serial.println(t25);

    delay(1000);

    // Test 3: 100 kHz (standard mode, prescaler = 1, TWBR = 72)
    configureI2CSpeed(100000);
    uint32_t t100 = run_test();
    Serial.print("100 kHz time (us): ");
    Serial.println(t100);

    delay(1000);

    // Test 4: 400 kHz (fast mode, prescaler = 1, TWBR = 12)
    configureI2CSpeed(400000);
    uint32_t t400 = run_test();
    Serial.print("400 kHz time (us): ");
    Serial.println(t400);

    Serial.println("TEST COMPLETE");
}

void loop()
{
    // Empty loop
}
